name: Release

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ä¸” manifest.json å˜æ›´
on:
  push:
    branches:
      - main
    paths:
      - 'manifest.json'

# æƒé™è®¾ç½®
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. è¯»å–ç‰ˆæœ¬å·
      - name: è¯»å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=$(node scripts/get-version.js)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æ£€æµ‹åˆ°ç‰ˆæœ¬: v$VERSION"
      
      # 4. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # 5. æ‰§è¡Œæ‰“åŒ…
      - name: æ‰“åŒ…æ‰©å±•
        run: npm run pack
      
      # 6. éªŒè¯æ‰“åŒ…æ–‡ä»¶
      - name: éªŒè¯æ‰“åŒ…æ–‡ä»¶
        run: |
          if [ ! -f "blinko-extension.zip" ]; then
            echo "âŒ æ‰“åŒ…æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "blinko-extension.zip")
          if [ $FILE_SIZE -lt 1000 ]; then
            echo "âŒ æ‰“åŒ…æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          echo "âœ“ æ‰“åŒ…æ–‡ä»¶éªŒè¯é€šè¿‡: $FILE_SIZE bytes"
      
      # 7. åˆ›å»º GitHub Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          files: blinko-extension.zip
          body: |
            ## ğŸ‰ Blinko ç½‘é¡µå‰ªè—åŠ©æ‰‹ v${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¥ ä¸‹è½½å®‰è£…
            
            1. ä¸‹è½½ä¸‹æ–¹çš„ `blinko-extension.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
            4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„ç›®å½•
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            
            æŸ¥çœ‹è¯¦ç»†æ›´æ–°æ—¥å¿—ï¼š[CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            
            å¦‚æœ‰é—®é¢˜è¯·è®¿é—® [Issues](https://github.com/${{ github.repository }}/issues)
            
            ---
            
            **å‘å¸ƒæ—¶é—´**ï¼š${{ github.event.head_commit.timestamp }}  
            **æäº¤ä¿¡æ¯**ï¼š${{ github.event.head_commit.message }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


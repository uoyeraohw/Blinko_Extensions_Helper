# Blinko Chrome æ‰©å±• - å¼€å‘è€…æ–‡æ¡£

## é¡¹ç›®æ¶æ„

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Chrome Extension                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Popup      â”‚  â”‚   Settings   â”‚  â”‚  Background  â”‚ â”‚
â”‚  â”‚  (popup.html)â”‚  â”‚(settings.html)â”‚  â”‚(background.js)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                          â”‚                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                                  â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Utils      â”‚               â”‚  Content Script â”‚    â”‚
â”‚  â”‚  - storage   â”‚               â”‚(content-script.js)â”‚    â”‚
â”‚  â”‚  - api       â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚  - markdown  â”‚                                       â”‚
â”‚  â”‚  - s3        â”‚                                       â”‚
â”‚  â”‚  - template  â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Blinko    â”‚      â”‚   OpenAI    â”‚
    â”‚     API     â”‚      â”‚     API     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„è¯´æ˜

```
blinko_plugin/
â”œâ”€â”€ manifest.json          # Chromeæ‰©å±•æ¸…å•
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ popup.html        # å¼¹å‡ºçª—å£UI
â”‚   â”œâ”€â”€ popup.js          # å¼¹å‡ºçª—å£é€»è¾‘
â”‚   â”œâ”€â”€ settings.html     # è®¾ç½®é¡µé¢UI
â”‚   â”œâ”€â”€ settings.js       # è®¾ç½®é¡µé¢é€»è¾‘
â”‚   â”œâ”€â”€ content-script.js # å†…å®¹è„šæœ¬ï¼ˆæ³¨å…¥ç½‘é¡µï¼‰
â”‚   â”œâ”€â”€ background.js     # åå°æœåŠ¡è„šæœ¬
â”‚   â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•°åº“
â”‚   â”‚   â”œâ”€â”€ storage.js         # Chrome Storageå°è£…
â”‚   â”‚   â”œâ”€â”€ html-to-markdown.js # HTMLè½¬Markdown
â”‚   â”‚   â”œâ”€â”€ api-client.js      # APIå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ s3-uploader.js     # S3ä¸Šä¼ å·¥å…·
â”‚   â”‚   â””â”€â”€ template-matcher.js # æ¨¡æ¿åŒ¹é…å¼•æ“
â”‚   â””â”€â”€ styles/           # æ ·å¼æ–‡ä»¶
â”‚       â”œâ”€â”€ popup.css
â”‚       â””â”€â”€ settings.css
â”œâ”€â”€ icons/                # æ‰©å±•å›¾æ ‡
â”œâ”€â”€ dist/                 # æ„å»ºè¾“å‡º
â””â”€â”€ openspec/             # OpenSpecè§„æ ¼æ–‡æ¡£
```

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. Storage Module (storage.js)

è´Ÿè´£æ‰€æœ‰é…ç½®æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- `saveConfig(key, value)` - ä¿å­˜é…ç½®
- `getConfig(key, defaultValue)` - è¯»å–é…ç½®
- `exportConfig()` - å¯¼å‡ºé…ç½®ä¸ºJSON
- `importConfig(jsonData)` - ä»JSONå¯¼å…¥é…ç½®

**æ•°æ®å­˜å‚¨ï¼š**
ä½¿ç”¨ `chrome.storage.sync` APIï¼Œæ•°æ®ä¼šåœ¨ç™»å½•Chromeè´¦å·çš„è®¾å¤‡é—´åŒæ­¥ã€‚

**å­˜å‚¨çš„é…ç½®é¡¹ï¼š**
```javascript
{
  // Blinkoé…ç½®
  blinko_api_url: string
  blinko_authorization: string
  
  // OpenAIé…ç½®
  openai_base_url: string
  openai_key: string
  openai_model: string
  
  // æ¨¡æ¿
  templates: Array<{name: string, content: string}>
  default_template: string
  domain_rules: Array<{pattern: string, type: string, templateName: string}>
  
  // æ ‡ç­¾
  tag_summary: string
  tag_selection: string
  tag_image: string
  tag_clipping: string
  
  // é€šç”¨è®¾ç½®
  include_link_summary: boolean
  include_link_selection: boolean
  include_link_image: boolean
  include_link_quick_note: boolean
  
  // S3é…ç½®
  keep_original_image_link: boolean
  s3_access_key: string
  s3_secret_key: string
  s3_endpoint: string
  s3_region: string
  s3_bucket: string
  s3_cdn: string
  s3_custom_path: string
}
```

### 2. HTML to Markdown Module (html-to-markdown.js)

å°†ç½‘é¡µHTMLå†…å®¹è½¬æ¢ä¸ºMarkdownæ ¼å¼ã€‚

**æ ¸å¿ƒå‡½æ•°ï¼š**
- `htmlToMarkdown(html, includeImages)` - ä¸»è½¬æ¢å‡½æ•°
- `extractMainContent(doc)` - æå–ä¸»è¦å†…å®¹åŒºåŸŸ
- `cleanDocument(doc)` - æ¸…ç†æ— ç”¨å…ƒç´ 

**è½¬æ¢è§„åˆ™ï¼š**
- æ ‡é¢˜ (h1-h6) â†’ `# æ ‡é¢˜`
- æ®µè½ (p) â†’ æ¢è¡Œ
- ç²—ä½“ (strong/b) â†’ `**æ–‡æœ¬**`
- æ–œä½“ (em/i) â†’ `*æ–‡æœ¬*`
- é“¾æ¥ (a) â†’ `[æ–‡æœ¬](URL)`
- å›¾ç‰‡ (img) â†’ `![alt](URL)`
- ä»£ç å— (pre/code) â†’ ` ```ä»£ç ``` `
- åˆ—è¡¨ (ul/ol) â†’ `- é¡¹ç›®` æˆ– `1. é¡¹ç›®`
- è¡¨æ ¼ (table) â†’ Markdownè¡¨æ ¼

### 3. API Client Module (api-client.js)

å¤„ç†ä¸å¤–éƒ¨APIçš„é€šä¿¡ã€‚

**Blinko APIï¼š**
- `validateBlinkoConnection(apiUrl, token)` - éªŒè¯è¿æ¥
- `createNote(apiUrl, token, content, type)` - åˆ›å»ºç¬”è®°

**OpenAI APIï¼š**
- `validateOpenAI(baseUrl, apiKey, model)` - éªŒè¯é…ç½®
- `summarizeContent(...)` - æ€»ç»“å†…å®¹

**é”™è¯¯å¤„ç†ï¼š**
- ç½‘ç»œè¶…æ—¶ï¼ˆ30ç§’ï¼‰
- HTTPé”™è¯¯çŠ¶æ€ç 
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰

### 4. S3 Uploader Module (s3-uploader.js)

**æ³¨æ„ï¼š** å½“å‰å®ç°ä¸ºç®€åŒ–ç‰ˆæœ¬ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦é›†æˆå®Œæ•´çš„AWS SDKã€‚

**åŠŸèƒ½ï¼š**
- `validateS3Config(config)` - éªŒè¯é…ç½®
- `uploadImage(imageBlob, filename, s3Config)` - ä¸Šä¼ å›¾ç‰‡
- `processImages(imageUrls, s3Config)` - æ‰¹é‡å¤„ç†å›¾ç‰‡
- `replaceImageUrls(markdown, urlMap)` - æ›¿æ¢URL

**å¹¶å‘æ§åˆ¶ï¼š**
æœ€å¤šåŒæ—¶ä¸Šä¼ 5å¼ å›¾ç‰‡ï¼Œé¿å…è¯·æ±‚è¿‡å¤šã€‚

### 5. Template Matcher Module (template-matcher.js)

æ ¹æ®URLåŒ¹é…åˆé€‚çš„æ€»ç»“æ¨¡æ¿ã€‚

**åŒ¹é…ç±»å‹ï¼š**
1. **æ­£åˆ™è¡¨è¾¾å¼** (`regex`) - ä½¿ç”¨æ­£åˆ™åŒ¹é…URL
2. **ä¸»åŸŸååŒ¹é…** (`domain`) - åŒ¹é…ä¸»åŸŸååŠå­åŸŸå
3. **å®Œæ•´URL** (`exact`) - ç²¾ç¡®åŒ¹é…å®Œæ•´URL

**åŒ¹é…ä¼˜å…ˆçº§ï¼š**
åŸŸåè§„åˆ™æŒ‰æ·»åŠ é¡ºåºåŒ¹é…ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆã€‚

**å˜é‡æ›¿æ¢ï¼š**
- å¦‚æœæ¨¡æ¿åŒ…å« `{{content}}`ï¼Œæ›¿æ¢åä½œä¸ºuser prompt
- å¦åˆ™ï¼Œæ¨¡æ¿ä½œä¸ºsystem promptï¼Œå†…å®¹ä½œä¸ºuser prompt

## æ¶ˆæ¯ä¼ é€’æµç¨‹

### Popup â†’ Content Script

```javascript
// popup.js
const response = await chrome.tabs.sendMessage(tabId, {
  action: 'extract-content'
});

// content-script.js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'extract-content') {
    const html = extractPageContent();
    sendResponse({ success: true, html: html });
  }
});
```

### å³é”®èœå• â†’ Background Script

```javascript
// background.js
chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === 'save-selection-to-blinko') {
    handleSaveSelection(info, tab);
  }
});
```

## APIè°ƒç”¨æµç¨‹

### ç½‘é¡µå‰ªè—æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"æå–ç½‘é¡µæ­£æ–‡"
   â†“
2. Popupå‘é€æ¶ˆæ¯åˆ°Content Script
   â†“
3. Content Scriptæå–HTMLå¹¶è¿”å›
   â†“
4. Popupè°ƒç”¨htmlToMarkdownè½¬æ¢
   â†“
5. å¦‚æœé…ç½®äº†S3ï¼Œä¸Šä¼ å›¾ç‰‡å¹¶æ›¿æ¢URL
   â†“
6. æ·»åŠ æ ‡ç­¾å’Œç½‘é¡µé“¾æ¥
   â†“
7. æ˜¾ç¤ºåœ¨é¢„è§ˆæ¡†
   â†“
8. ç”¨æˆ·ç‚¹å‡»"æäº¤"
   â†“
9. è°ƒç”¨Blinko APIä¿å­˜
```

### AIæ€»ç»“æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"æå–å¹¶æ€»ç»“"
   â†“
2. æå–ç½‘é¡µHTMLå¹¶è½¬æ¢ï¼ˆä¸å«å›¾ç‰‡ï¼‰
   â†“
3. æ ¹æ®URLåŒ¹é…æ¨¡æ¿
   â†“
4. æ›¿æ¢æ¨¡æ¿å˜é‡
   â†“
5. è°ƒç”¨OpenAI API
   â†“
6. è¿”å›æ€»ç»“ç»“æœ
   â†“
7. æ·»åŠ æ ‡ç­¾å’Œé“¾æ¥
   â†“
8. æ˜¾ç¤ºåœ¨é¢„è§ˆæ¡†
```

## å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd blinko_plugin
```

### 2. å®‰è£…ä¾èµ–ï¼ˆå¯é€‰ï¼‰
```bash
npm install
```

### 3. åŠ è½½æ‰©å±•åˆ°Chrome

1. æ‰“å¼€ Chromeæµè§ˆå™¨
2. è®¿é—® `chrome://extensions/`
3. å¼€å¯å³ä¸Šè§’"å¼€å‘è€…æ¨¡å¼"
4. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
5. é€‰æ‹©é¡¹ç›®æ ¹ç›®å½•

### 4. å¼€å‘è°ƒè¯•

**è°ƒè¯•Popupï¼š**
- å³é”®æ‰©å±•å›¾æ ‡ â†’ "æ£€æŸ¥å¼¹å‡ºå†…å®¹"
- æˆ–åœ¨popupæ‰“å¼€æ—¶æŒ‰F12

**è°ƒè¯•Settingsï¼š**
- å³é”®æ‰©å±•å›¾æ ‡ â†’ "é€‰é¡¹" â†’ F12

**è°ƒè¯•Content Scriptï¼š**
- åœ¨ç›®æ ‡ç½‘é¡µæŒ‰F12
- Consoleä¸­ä¼šæ˜¾ç¤ºcontent scriptçš„æ—¥å¿—

**è°ƒè¯•Background Scriptï¼š**
- `chrome://extensions/` â†’ æ‰¾åˆ°æ‰©å±• â†’ "Service Worker" â†’ "æ£€æŸ¥è§†å›¾"

### 5. å®æ—¶é‡è½½

ä¿®æ”¹ä»£ç åéœ€è¦ï¼š
1. è®¿é—® `chrome://extensions/`
2. ç‚¹å‡»æ‰©å±•çš„åˆ·æ–°æŒ‰é’®ğŸ”„
3. é‡æ–°æ‰“å¼€popupæˆ–settings

## ä»£ç è§„èŒƒ

### JavaScripté£æ ¼
- ä½¿ç”¨ES6+ è¯­æ³•
- ä½¿ç”¨ `const` å’Œ `let`ï¼Œé¿å… `var`
- å‡½æ•°ä½¿ç”¨ç®­å¤´å‡½æ•°æˆ–functionå£°æ˜
- å¼‚æ­¥æ“ä½œä½¿ç”¨ `async/await`

### å‘½åçº¦å®š
- å˜é‡å’Œå‡½æ•°ï¼šcamelCase
- å¸¸é‡ï¼šUPPER_SNAKE_CASE
- ç±»ï¼šPascalCase
- æ–‡ä»¶åï¼škebab-case

### æ³¨é‡Š
```javascript
/**
 * å‡½æ•°è¯´æ˜
 * @param {string} param1 - å‚æ•°è¯´æ˜
 * @returns {Promise<Object>} è¿”å›å€¼è¯´æ˜
 */
async function example(param1) {
  // å®ç°
}
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è°ƒè¯•Content Scriptï¼Ÿ
A: åœ¨ç›®æ ‡ç½‘é¡µæ‰“å¼€å¼€å‘è€…å·¥å…·(F12)ï¼Œcontent scriptçš„æ—¥å¿—ä¼šæ˜¾ç¤ºåœ¨Consoleä¸­ã€‚

### Q: ä¿®æ”¹ä»£ç åä¸ç”Ÿæ•ˆï¼Ÿ
A: éœ€è¦åœ¨chrome://extensions/é¡µé¢åˆ·æ–°æ‰©å±•ï¼Œç„¶åé‡æ–°æ‰“å¼€popupæˆ–é‡æ–°åŠ è½½ç½‘é¡µã€‚

### Q: Service WorkeræŠ¥é”™ï¼Ÿ
A: Manifest V3ä½¿ç”¨Service Workeræ›¿ä»£Background Pageï¼Œä¸æ”¯æŒDOMæ“ä½œï¼Œåªèƒ½ä½¿ç”¨Chrome APIsã€‚

### Q: å¦‚ä½•æµ‹è¯•S3ä¸Šä¼ ï¼Ÿ
A: å½“å‰å®ç°ä¸ºç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…ä½¿ç”¨éœ€è¦é›†æˆ@aws-sdk/client-s3åº“ã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‡å°‘Storageè¯»å†™**ï¼šæ‰¹é‡è¯»å†™ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
2. **å›¾ç‰‡å¤„ç†**ï¼šä½¿ç”¨Web Workerå¤„ç†å¤§é‡å›¾ç‰‡
3. **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½å¤§å‹åº“
4. **ç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨é…ç½®å’Œæ¨¡æ¿
5. **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶åŒæ—¶è¿›è¡Œçš„ç½‘ç»œè¯·æ±‚æ•°é‡

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥**ï¼šæ°¸è¿œä¸è¦ç¡¬ç¼–ç APIå¯†é’¥
2. **XSSé˜²æŠ¤**ï¼šä½¿ç”¨textContentè€ŒéinnerHTML
3. **CSRF**ï¼šéªŒè¯æ¥æº
4. **Content Security Policy**ï¼šéµå®ˆCSPè§„åˆ™
5. **æƒé™æœ€å°åŒ–**ï¼šåªè¯·æ±‚å¿…è¦çš„æƒé™

## è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. æäº¤Pull Request

## å‚è€ƒèµ„æ–™

- [Chrome Extensionæ–‡æ¡£](https://developer.chrome.com/docs/extensions/)
- [Manifest V3è¿ç§»æŒ‡å—](https://developer.chrome.com/docs/extensions/mv3/intro/)
- [Chrome Storage API](https://developer.chrome.com/docs/extensions/reference/storage/)
- [Content Scripts](https://developer.chrome.com/docs/extensions/mv3/content_scripts/)



